#!/usr/bin/bash

unset PACTRANS CONFLICTFL
[ "$EUID" != 0 ] && \
PACTRANS=(/usr/bin/sudo)
PACTRANS+=(/usr/bin/pactrans --sysupgrade --yolo)
FIFOFL="/tmp/.rupd.$RUNPID"

grep "^\[blackarch\]" "/etc/pacman.conf" &>/dev/null && \
    blackarch_keyring="blackarch-keyring"||\
    unset blackarch_keyring

/usr/bin/pac -Sy archlinux-keyring chaotic-keyring \
    $blackarch_keyring --needed --noconfirm||exit 1

cleanup() {
    rm -rf "$FIFOFL"
    kill $PACTRANSPID 2>/dev/null
}
trap 'cleanup' EXIT SIGINT SIGTERM

mkfifo "$FIFOFL"

"${PACTRANS[@]}"|& tee "$FIFOFL" &
PACTRANSPID=$!

CONFLICTFL=(
    $(grep "file conflict:" "$FIFOFL"|\
      awk '{print$3}'|sed "s|'||g")
)

if [ -n "$CONFLICTFL" ]
    then
        is_conflict=1
        rm -rvf "${CONFLICTFL[@]}"
        "${PACTRANS[@]}"
fi

exit $?
